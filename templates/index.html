<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Health Monitoring Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Arial', sans-serif;
        }
        .card {
            margin: 20px;
        }
        canvas {
            margin: 10px auto;
        }
        .dark-mode {
            background-color: #343a40;
            color: white;
        }
        .dark-mode .card {
            background-color: #495057;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="text-center mb-4">IoT Health Monitoring Dashboard</h1>

        <!-- Key Statistics Cards -->
        <div class="row text-center">
            <div class="col-md-4">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Température</h5>
                        <h3 id="temperatureValue">-- °C</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h5 class="card-title">Fréquence cardiaque</h5>
                        <h3 id="heartrateValue">-- BPM</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">SpO2</h5>
                        <h3 id="spo2Value">-- %</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graphs -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        Temperature (°C)
                    </div>
                    <div class="card-body">
                        <canvas id="temperatureChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        Heart Rate (BPM)
                    </div>
                    <div class="card-body">
                        <canvas id="heartrateChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        SpO2 (%)
                    </div>
                    <div class="card-body">
                        <canvas id="spo2Chart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historical Data Table -->
        <table class="table table-striped mt-4">
            <thead>
                <tr>
                    <th scope="col">Temps</th>
                    <th scope="col">Température (°C)</th>
                    <th scope="col">Fréquence cardiaque (BPM)</th>
                    <th scope="col">SpO2 (%)</th>
                </tr>
            </thead>
            <tbody id="dataTable">
                <!-- Les lignes seront insérées dynamiquement -->
            </tbody>
        </table>

        <!-- Anomalies Table -->
        <h3 class="mt-5">Anomalies Détectées</h3>
        <table class="table table-striped mt-2">
            <thead>
                <tr>
                    <th scope="col">Temps</th>
                    <th scope="col">Paramètre</th>
                    <th scope="col">Valeur</th>
                    <th scope="col">Type d'Anomalie</th>
                </tr>
            </thead>
            <tbody id="anomaliesTable">
                <!-- Les anomalies seront insérées dynamiquement -->
            </tbody>
        </table>

        <!-- Dark Mode Toggle -->
        <button id="toggleDarkMode" class="btn btn-secondary">Activer le mode sombre</button>
    </div>

    <audio id="normalSound" src="static/audio/normal.mp3" loop></audio>
    <audio id="anomalySound" src="static/audio/anomaly.mp3"></audio>

    <script>
        let temperatureData = [];
        let heartrateData = [];
        let spo2Data = [];
        let labels = [];

        async function fetchData(endpoint, dataKey, chart, dataset, soundIdNormal, soundIdAnomaly, valueElementId) {
            try {
                const response = await fetch(endpoint);
                const data = await response.json();

                const anomaly = data.anomaly;

                if (data[dataKey] !== undefined) {
                    const currentTime = new Date().toLocaleTimeString();
                    dataset.push(data[dataKey]);
                    if (dataset.length > 10) {
                        dataset.shift();
                        labels.shift();
                    }
                    labels.push(currentTime);

                    chart.data.labels = labels;
                    chart.data.datasets[0].data = dataset;
                    chart.update();

                    // Mettre à jour la dernière valeur dans la carte
                    document.getElementById(valueElementId).textContent = `${data[dataKey]} ${valueElementId === "temperatureValue" ? "°C" : valueElementId === "heartrateValue" ? "BPM" : "%"}`;

                    if (anomaly && anomaly !== "Normal") {
                        playSound(soundIdAnomaly);
                        addAnomalyRow(currentTime, dataKey, data[dataKey], anomaly);
                    } else {
                        playSound(soundIdNormal);
                    }
                }
            } catch (error) {
                console.error(`Error fetching ${dataKey}:`, error);
            }
        }

        function playSound(soundId) {
            const sound = document.getElementById(soundId);
            sound.pause();
            sound.currentTime = 0;
            sound.play();
        }

        function addTableRow(time, temperature, heartrate, spo2) {
            const table = document.getElementById("dataTable");
            const rows = table.querySelectorAll("tr");

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${time}</td>
                <td>${temperature || "--"}</td>
                <td>${heartrate || "--"}</td>
                <td>${spo2 || "--"}</td>
            `;

            table.prepend(row);

            // Supprimer les lignes excédentaires pour ne garder que les 10 dernières
            if (rows.length >= 10) {
                rows[rows.length - 1].remove();
            }
        }

        function addAnomalyRow(time, parameter, value, anomalyType) {
            const anomaliesTable = document.getElementById("anomaliesTable");
            const rows = anomaliesTable.querySelectorAll("tr");

            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${time}</td>
                <td>${parameter}</td>
                <td>${value}</td>
                <td>${anomalyType}</td>
            `;

            anomaliesTable.prepend(row);

            // Supprimer les lignes excédentaires pour ne garder que les 10 dernières
            if (rows.length >= 10) {
                rows[rows.length - 1].remove();
            }
        }

        function checkAnomalies(temp, heartrate, spo2) {
            const tempCard = document.querySelector(".card.bg-primary");
            const hrCard = document.querySelector(".card.bg-danger");
            const spo2Card = document.querySelector(".card.bg-success");

            tempCard.style.backgroundColor = (temp > 37.2 || temp < 36.1) ? "#ffc107" : "#007bff";
            hrCard.style.backgroundColor = (heartrate > 100 || heartrate < 60) ? "#ffc107" : "#dc3545";
            spo2Card.style.backgroundColor = (spo2 < 90) ? "#ffc107" : "#28a745";
        }

        document.getElementById("toggleDarkMode").addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
        });

        window.onload = function () {
            const tempCtx = document.getElementById("temperatureChart").getContext("2d");
            const hrCtx = document.getElementById("heartrateChart").getContext("2d");
            const spo2Ctx = document.getElementById("spo2Chart").getContext("2d");

            const temperatureChart = new Chart(tempCtx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Temperature (°C)",
                        data: temperatureData,
                        borderColor: "rgba(54, 162, 235, 1)",
                        backgroundColor: "rgba(54, 162, 235, 0.2)",
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: "Time" } },
                        y: { title: { display: true, text: "Temperature (°C)" } }
                    }
                }
            });

            const heartrateChart = new Chart(hrCtx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Heart Rate (BPM)",
                        data: heartrateData,
                        borderColor: "rgba(255, 99, 132, 1)",
                        backgroundColor: "rgba(255, 99, 132, 0.2)",
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: "Time" } },
                        y: { title: { display: true, text: "Heart Rate (BPM)" } }
                    }
                }
            });

            const spo2Chart = new Chart(spo2Ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "SpO2 (%)",
                        data: spo2Data,
                        borderColor: "rgba(75, 192, 192, 1)",
                        backgroundColor: "rgba(75, 192, 192, 0.2)",
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: { title: { display: true, text: "Time" } },
                        y: { title: { display: true, text: "SpO2 (%)" } }
                    }
                }
            });

            setInterval(() => fetchData("/temperature", "temperature", temperatureChart, temperatureData, "normalSound", "anomalySound", "temperatureValue"), 2000);
            setInterval(() => fetchData("/heartrate", "heartrate", heartrateChart, heartrateData, "normalSound", "anomalySound", "heartrateValue"), 2000);
            setInterval(() => fetchData("/spo2", "spo2", spo2Chart, spo2Data, "normalSound", "anomalySound", "spo2Value"), 2000);

            setInterval(async () => {
                const currentTime = new Date().toLocaleTimeString();

                const tempResponse = await fetch("/temperature");
                const heartrateResponse = await fetch("/heartrate");
                const spo2Response = await fetch("/spo2");

                const tempData = await tempResponse.json();
                const heartrateData = await heartrateResponse.json();
                const spo2Data = await spo2Response.json();

                addTableRow(currentTime, tempData.temperature, heartrateData.heartrate, spo2Data.spo2);
                checkAnomalies(tempData.temperature, heartrateData.heartrate, spo2Data.spo2);
            }, 2000);
        };
    </script>
</body>
</html>
